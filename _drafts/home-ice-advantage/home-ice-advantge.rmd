---
title: "Is Home Ice Advantage in the NHL Real?"
author: "Everett Robinson"
date: "February 19, 2018"
output: html_document
---

Many people have attempted to answer the question of whether or not home ice advantage exists. A [2013 paper](http://people.stat.sfu.ca/~tim/papers/hca.pdf) by Tim Swartz and Adriano Arce came to the conclusion that home ice advantage in the NHL is real, accounting for about 5% of goals in 2012. Furthermore, they observed that when total goals per game are accoutned for, there is no appreciable change in the home ice advantage over time. Lastly, they performed a one way ANOVA and a pairwise Tukey's HSD test on 16 NHL teams that have played in 30 seasons to determine if there is a significant difference between teams' home ice advantages. The result from their analysis was that there is not sufficient evidence to conclude that home ice advantage varies between teams.

Later in 2017, a [fivethirtyeight blog post](https://fivethirtyeight.com/features/a-home-playoff-game-is-a-big-advantage-unless-you-p lay-hockey/) also tried to tackle this problem, coming to the conclusion that home ice in the regular season amounts to a win percentage of 55.1%, 5.1% better than even odds. In the playoffs this advantage declines slightly to a boost in win percentage that is only 4.8% better on home ice than at a theoretical neutral rink.

The above two results appear fairly consistent with each other, and one might be satisfied that home ice advantage is a real phenomenon. This is probably a safe bet, but I'm all for reproducible research so I'm going to try my hand at answering this question myself and corroborating the previus findings.

There are two questions that I want to attempt to answer:

1. Is there evidence for home ice being advantageous in general? 
2. Is there evidence that this advantage varies from team to team?

I would also like to quantify the extent of home ice advantage in the above analysis, mainly in terms of the expected goal differential it causes. To do all of this I am going to a few different strategies. The first will be a frequentist statistical approach using a paired sample t-test on the home and away teams goals if the assumptions for this test are met. If the assumptions of normality or no outliers are not met, then I will use the  Wilcoxon signed-rank test.

Next, I will investigate the first problem again using a Bayesian approach. To accomplish this, I will use a model based on John Kruschke's [Bayesian estimation supercedes the t-test](http://www.indiana.edu/~kruschke/BEST/BEST.pdf). To do this I will simply use Kruschke's own R package.

To answer the second question, I will implement a one way ANOVA on the collected data to test for sigificant differences in home ice advantage by team.


### Acquiring Official NHL Data

To start, we will need to get the data for NHL games that have already been played. I will do this using the undocumented NHL statistics API, which returns json files with a mostly self evident structure. These files will be retrieved and parsed using Python and the very easy requests and json libraries. 

```{python, engine = python3}
import requests
import json
import pandas as pd

response = requests.get("https://statsapi.web.nhl.com/api/v1/schedule?startDate=2013-09-18&endDate=2017-08-1")
schedule_json = response.json()

# A function to extract the relevant data from the schedule
# and return it as a pandas dataframe
def extract_game_data(schedule):
    """Given full JSON records for games from the NHL API,
    returns a simplified list of just the data we need.
    """
    games = pd.DataFrame(columns=['date', 
                                  'home_team', 
                                  'home_team_score', 
                                  'away_team', 
                                  'away_team_score'])
    
    for date_obj in schedule_json['dates']:
        date = date_obj['date'];
        for game_obj in date_obj['games']:
            game_type = game_obj['gameType']
            season = game_obj['season']
            home_team_obj = game_obj['teams']['home']
            away_team_obj = game_obj['teams']['away']
            
            home_team = home_team_obj['team']['name']
            home_team_score = home_team_obj['score']
            
            away_team = away_team_obj['team']['name']
            away_team_score = away_team_obj['score']
            
            games = games.append({'date': date,
                                  'season': season,
                                  'game_type': game_type,
                                  'home_team': home_team,
                                  'home_team_score': home_team_score,
                                  'away_team': away_team,
                                  'away_team_score': away_team_score
                                  }, ignore_index=True)
    
    return games
    
games = extract_game_data(schedule_json)
games.to_csv('games.csv', index = False)
```


### T-test Assumptions

```{r}
library(tidyverse)
library(lubridate)

games <- read_csv("games.csv")
```

We will consider theregula r season games that have occured since the last NHL season that experienced a lock-out, the 2012-2013 season, to the end of the last complete season, the 2016-2017 season. This will avoid the current partial solution, which may effect the balance of home vs away games. It will also avoid any disruption and complications that are caused by the introduction of the Vegas Golden Knights, which acquired players from many other teams.

```{r}
reg_season_games <- games %>% 
  filter(game_type == "R")
dim(reg_season_games)
```

Filtering for the above conditions, 4920 regular season games were played across that time span. All teams should have played exactly 164 home games and exactly 164 away games one exception, the Arizona/Phoenix Coyotes. This team underwent a name change to become the Arizona Coyotes between the 2013-2014 and 2014-2015 seasons. To fix this I will simply rename all occurances of the Phoenix Coyotes to the Arizona Coyotes in the data.

```{r}
home_games_by_team <- reg_season_games %>% 
  group_by(home_team) %>% 
  count() %>% 
  rename(home_game_count = n, team = home_team)

away_games_by_team <- reg_season_games %>% 
  group_by(away_team) %>% 
  count() %>% 
  rename(away_game_count = n, team  = away_team)

game_counts_by_team <- home_games_by_team %>% 
  left_join(away_games_by_team) 

game_counts_by_team %>% 
  arrange(home_game_count) %>% 
  head()

game_counts_by_team %>% 
  arrange(home_game_count) %>% 
  tail()
```
```{r}
games$home_team[games$home_team == "Phoenix Coyotes"] = "Arizona Coyotes"
games$away_team[games$away_team == "Phoenix Coyotes"] = "Arizona Coyotes"

reg_season_games <- games %>% 
  filter(game_type == "R")

home_games_by_team <- reg_season_games %>% 
  group_by(home_team) %>% 
  count() %>% 
  rename(home_game_count = n, team = home_team)

away_games_by_team <- reg_season_games %>% 
  group_by(away_team) %>% 
  count() %>% 
  rename(away_game_count = n, team  = away_team)

game_counts_by_team <- home_games_by_team %>% 
  left_join(away_games_by_team) 
game_counts_by_team
```

Some teams are likely inherently stronger than other teams, so we will also want to be sure that the ratio of home to away games between any pair of teams is also close to 1:1. This will ensure that the confounding effect of relative strength is properly controlled for.

```{r, fig.width=8, fig.height=6}
# Get the count of each home_team away_team pair
game_balance_by_pairs <- reg_season_games %>% 
  select(home_team, away_team) %>%
  group_by(home_team, away_team) %>%
  count() %>%
  rename(home_game_count = n)

# Add the total for each matchup, regardless of which team was home or away
game_balance_by_pairs <- game_balance_by_pairs %>%
  mutate(matchup_count = home_game_count + 
                         game_balance_by_pairs[(game_balance_by_pairs$home_team == away_team &
                                                game_balance_by_pairs$away_team == home_team),
                                               'home_game_count'][[1]])

game_balance_by_pairs <- game_balance_by_pairs %>%
  mutate(home_game_proportion = home_game_count / matchup_count)

game_balance_by_pairs %>% ggplot(aes(x = home_team, y = away_team)) + 
  geom_tile(aes(fill = home_game_proportion)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
  ggtitle("Proportion of Games Played at Home for All\nPairs of NHL Teams (2012 - 2017)")
```

```{r}
min(game_balance_by_pairs$home_game_proportion)
max(game_balance_by_pairs$home_game_proportion)
```

With a minimum proportion of home games foe each team matchup at 0.4706, and a maximum proportion at 0.5294, it would appear to me that the relative difference in strength between teams is adequately controlled for.

Satisfied that the home and away games are distributed evenly across the 30 NHL teams in our data, we now need to verify two key assumptions before we can proceed with a paired t-test:

1. The distribution of (home_team_score - away_team_score) needs to be normal
2. The score differences for the games in our sample are independent of each other

If these assumptions are thoroughly violated, we may need to consider switching to another test that does not depend on the same assumptions, such as a Wilcoxon signed-rank test.

To test the first assumption, we will need to compute the difference in home team and away team goals:

```{r}
reg_season_games <- reg_season_games %>%
  mutate(score_diff = home_team_score - away_team_score)
```

```{r}
reg_season_games %>% 
  count(score_diff) %>%
  ggplot(aes(x = score_diff, y = n)) +
  geom_col()
```

Ignoring the gaping hole around score differences of zero, the above plot does look approximately normally distributed around a value slightly above zero. The reason that there are no score differences of zero is because NHL games that are tied at the end of regulation go into a five minute sudden death overtime, and then finally to a shootout if no team wins during that time. This necessarily forces one team to ultimately win the game, making tied final scores impossible. In addition to the hole in the plot, a normal distribution also assumes that the values are continuous, which is obviously not the case. Home team and away team scores are always whole numbers, which means the difference between the home team score and away team score is going to be an integer value. Because NHL rules preclude ties, it will obviously be a non-zero integer. The normal distribution is defined for continuous values, meaning the discrete distribution we have above is not technically normal. Once again, we will side step this minor problem by only claiming that our distribution is approximately normal. 

Given the number of games in our data set, I am satisfied with claiming the data passes the first assumption for a t-test. Having lots of data points affords some leeway when it comes to how strictly we need to enfore the assumption of normal data.

Testing for independence is not an easy task. For the paired t-test we hope to perform, we only need to show that the difference of scores (home_team_score - away_team_score) are independent across games. Dependence in this context is defined as the probability distribution of the score differential in one game being affected by the score differential of any previous games. To test whether or not the sampled games are independent, I will start by looking at the score differences over time. We hope to see no obvious trends in time, especiay not anything that looks cyclical or time dependent over a narrow timespan. If there are no apparent trends, I will be satisfied that independence holds:

```{r}
reg_season_games %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point(alpha = 0.2)
```

Considering all games played by all teams, the score differentals appear to be reasonably normal and stationary over time. At this high level view of the entire league, it does appear as though scores are independent between games. Let's see if this assumption holds up when we examine each team individually:

```{r}
teams <- reg_season_games$home_team %>% unique() %>% sort()

reg_season_games %>%
  filter(home_team %in% teams[1:10]) %>%
  group_by(home_team) %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_wrap(~home_team, ncol = 5)
```

```{r}
reg_season_games %>%
  filter(home_team %in% teams[11:20]) %>%
  group_by(home_team) %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_wrap(~home_team, ncol = 5)
```


```{r}
reg_season_games %>%
  filter(home_team %in% teams[21:30]) %>%
  group_by(home_team) %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point(alpha = 0.2) +
  geom_smooth() +
  facet_wrap(~home_team, ncol = 5)
```

Some teams appear to be much more up and down between seasons, though this is not unexpected. Teams regularly trade players, draft new ones, have veterans retire, or lose players to injury. All of these things can impact a teams ability to compete, and affect it's relative strength compared to other teams. As a result, the goal differential any particular team experiences on home ice is bound to change with time. It is possible that this means we are violating the assumption of independence.

To check if this is the case, we will use the Ljungâ€“Box test for autocorrelations in a time series dataset. [According to wikipedia](https://en.wikipedia.org/wiki/Ljung%E2%80%93Box_test#Box-Pierce_test), the Ljung-Box test sets up a hypothesis as follows:

* H0: The data are independently distributed (i.e. the correlations in the population from which the sample is taken are 0, so that any observed correlations in the data result from randomness of the sampling process).
* Ha: The data are not independently distributed; they exhibit serial correlation. 

```{r}
library(modelr)
library(broom)

season_ljung <- function(df) {
  Box.test(df$score_diff, lag = 1, type = "Ljung-Box")
}

ljung_by_team_and_season <- reg_season_games %>%
  group_by(home_team, season) %>%
  nest()

ljung_by_team_and_season <- ljung_by_team_and_season %>%
  mutate(model = map(data, season_ljung)) %>%
  mutate(ljung_stats = map(model, glance)) %>%
  unnest(ljung_stats)

ljung_by_team_and_season %>% 
  select(home_team, season, model, p.value) %>%
  arrange(p.value)
```

```{r}
reg_season_games %>%
  filter(home_team == "New York Rangers", season == "20162017") %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point() +
  geom_smooth(method = "lm")

reg_season_games %>%
  filter(home_team == "Colorado Avalanche", season == "20142015") %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point() +
  geom_smooth(method = "lm")

reg_season_games %>%
  filter(home_team == "Washington Capitals", season == "20142015") %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point() +
  geom_smooth(method = "lm")

reg_season_games %>%
  filter(home_team == "Ottawa Senators", season == "20142015") %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point() +
  geom_smooth(method = "lm")

reg_season_games %>%
  filter(home_team == "Nashville Predators", season == "20152016") %>%
  ggplot(aes(x = date, y = score_diff)) +
  geom_point() +
  geom_smooth(method = "lm")
```

Using the Ljung-Box test, we find that there are five team and season combinations where there is evidence for autocorrelation. Looking at the plot for the Rangers, it does appear that their home game goal differentials seem to alternate between clustering above zero, and then below zero across that season.

For the other four teams, the relationship between the score differential of one homegame and the next appears far less obvious. Regardless, the assumption of independence did fail for five team and season combinations, so we cannot claim that the assumption truly holds. That being said, I am inclined to believe that the data we have are independent enough that we do not need to reject the t-test as invalid on the basis of our second asumption. The reason for this is that our assumption that home game score differentials are independent only failed in 5 out of the 120 team and season combinations. I expect that the effect they will have on the outcome of our t-test will be marginal, and only worth revisting if the results of our t-test are borderline.


### Paired t-test: Does Home Ice Advantage Exist?

We can now move ahead and test the paired samples t-test for the NHL regular season:

```{r}
t.test(reg_season_games$home_team_score,
       reg_season_games$away_team_score,
       paired = TRUE,
       conf.level = 0.95)
```

Based on the data available, there appears to be a 0.257 goal advantage when playing on home ice, with a 95% confidence interval of 0.192 to 0.322. The p-value for the null hypothesis is very low at 1.195e-14, meaning that the probability of observing these data purely due to chance when no true effect exists are extremely low. Even with our trangressions of the assumptions required of a t-test, the case for home ice advantage really existing appears convincing.


### Kruschke's BEST Test: Does Home Ice Advantage Exist 2?

According to [Kruschke's paper](http://www.indiana.edu/~kruschke/articles/Kruschke2013JEPG.pdf), the BEST test is much more robust to violations of the assumption that data is normally distributed hen compaed to a normal t-test. This is due to it's use of numerical methods. There is no indication that it suffers any issues related to independence of data, so I assume that it is no more or less succeptible to minor deviations from independent data than our standard t-test is.

```{r}
library(BEST)

best_results <- BESTmcmc(reg_season_games$score_diff, priors = NULL, parallel = FALSE)
```

```{r}
plot(best_results)
```

```{r}
best_results
```

The BEST test has yielded a mean of 0.257, with a 95% Highest Density Interval (HDI) of 0.192 to 0.322. These are exactly the same results from the standard paired student's t-test we ran before. This is maybe not too surprising given the volume of data we had. Bayesian methods really shine when there is limted data, and in this case we definitly did not have that problem. When large amounts of data are available, the arguments for or againt frequentist statistics compared to bayesian statistics are essentially irrelevant.


